# Sync Repos Skill - Interactive Multi-Repository Sync with Claude

## Overview

This skill enables Claude to assist with syncing changes between:
- `cosmic-connect-desktop-app` (Rust - source)
- `cosmic-connect-core` (Rust - shared library)
- `cosmic-connect-android` (Kotlin - mobile client)

**Key Features:**
- Claude analyzes changes and identifies what needs syncing
- Interactive review and confirmation for each change
- Claude generates appropriate code for Rust and Kotlin
- Preserves language-specific idioms and patterns
- Verifies compatibility and suggests improvements

## Usage

```
/sync-repos [--since COMMIT]
```

## Workflow

### 1. Analysis Phase (Automated)
Claude will:
- Analyze recent commits in desktop-app
- Identify changes that affect protocol, errors, constants
- Check for breaking changes
- Categorize by target repository (core vs android)

### 2. Review Phase (Interactive)
Claude will present findings and ask:
- "I found protocol version change - shall I sync to both core and android?"
- "New packet type detected - update android only?"
- "Error type modified - how should we translate to Kotlin?"

### 3. Generation Phase (AI-Assisted)
For each approved change, Claude will:
- Generate Rust code for cosmic-connect-core
- Generate Kotlin code for cosmic-connect-android
- Preserve language idioms and best practices
- Add appropriate comments and documentation

### 4. Verification Phase (Interactive)
Claude will:
- Show you the generated code
- Explain the changes and rationale
- Ask for approval before creating commits
- Run tests if requested

## Configuration

The skill uses `.sync-config.yaml` to understand:
- Which files to track
- What patterns indicate sync needs
- Target repositories and their languages
- Component boundaries

## Example Session

```
You: /sync-repos

Claude:
üîç Analyzing cosmic-connect-desktop-app changes...

Found 8 commits since last sync (commit: abc123f)

üì¶ Changes detected:

1. **Protocol Version Update** [CRITICAL]
   - File: cosmic-connect-protocol/src/lib.rs
   - Change: PROTOCOL_VERSION: 7 ‚Üí 8
   - Affects: ‚úÖ core, ‚úÖ android

   Shall I sync this to both repositories? [y/n]

You: y

Claude:
‚úÖ Generating sync code...

ü¶Ä For cosmic-connect-core:
```rust
// Update protocol version
pub const PROTOCOL_VERSION: u32 = 8;
```

ü§ñ For cosmic-connect-android:
```kotlin
// Update protocol version
const val PROTOCOL_VERSION = 8
```

Shall I create commits in each repo? [y/n]

You: y

Claude:
‚úÖ Created commits:
- cosmic-connect-core: feat: update protocol version to 8
- cosmic-connect-android: feat: update protocol version to 8

Next change...

2. **New Packet Type** [HIGH]
   - File: cosmic-connect-protocol/src/plugins/telephony.rs
   - New packet: "kdeconnect.telephony.request_mute"
   - Affects: ‚úÖ android (needs packet handler)

   This requires Android implementation. Shall I generate the Kotlin data class
   and suggest where to add the handler? [y/n]

You: y

Claude:
‚úÖ Generating Android code...

[Shows generated Kotlin code and integration points]

Would you like me to:
  a) Just generate the code snippets for manual copying
  b) Create a branch and commit in android repo
  c) Create a GitHub PR draft

Choose [a/b/c]:
```

## What Claude Will Check

### Protocol Changes
- Version bumps
- New packet types
- Changed packet structures
- Capability additions/removals

### Error Types
- New error variants
- Changed error messages
- Error classification changes
- Translates Rust enum to Kotlin sealed class

### Constants
- Ports, timeouts, buffer sizes
- Magic numbers
- Configuration defaults

### API Changes
- Breaking changes detection
- Backward compatibility check
- Migration guide generation

## Language Translation

Claude will translate between Rust and Kotlin:

**Rust Enum ‚Üí Kotlin Sealed Class**
```rust
// Rust
pub enum ProtocolError {
    Timeout(String),
    NotPaired,
}
```

```kotlin
// Kotlin (generated by Claude)
sealed class ProtocolError(message: String) : Exception(message) {
    class Timeout(details: String) : ProtocolError("Timeout: $details")
    object NotPaired : ProtocolError("Device not paired")
}
```

**Rust Struct ‚Üí Kotlin Data Class**
```rust
// Rust
pub struct FileTransferInfo {
    pub filename: String,
    pub size: u64,
}
```

```kotlin
// Kotlin (generated by Claude)
data class FileTransferInfo(
    val filename: String,
    val size: Long
)
```

## Safety Features

1. **No Automatic File Sync** - Claude always asks for confirmation
2. **Breaking Change Detection** - Claude warns about compatibility issues
3. **Test Recommendations** - Claude suggests tests to run
4. **Rollback Guidance** - Claude provides rollback instructions if needed
5. **Dependency Tracking** - Claude identifies dependent changes

## Advanced Features

### Intelligent Conflict Resolution
If Claude detects conflicting changes in target repos:
```
‚ö†Ô∏è Conflict detected in cosmic-connect-android!

Your change: PROTOCOL_VERSION = 8
Android's current: PROTOCOL_VERSION = 7 (modified 2 days ago)

The android repo may have unpushed changes. Should I:
  a) Sync anyway (overwrite android's change)
  b) Skip this sync
  c) Let you review android's changes first

Choose [a/b/c]:
```

### Multi-Step Changes
For complex changes requiring multiple steps:
```
üìã This change requires multiple steps:

1. Update protocol version in core
2. Add new packet type to android
3. Update android capability manifest
4. Add integration test

Shall I guide you through each step? [y/n]
```

### Dependency Analysis
```
üîó Dependency Analysis:

This change depends on:
  - cosmic-connect-core v0.5.0+ (current: v0.4.2)

Shall I:
  a) Update core version first
  b) Make this change backward-compatible
  c) Skip for now

Choose [a/b/c]:
```

## Integration with Development Workflow

### Pre-commit Hook (Optional)
```bash
# .git/hooks/pre-commit
#!/bin/bash
if [[ $(git diff --cached --name-only) =~ "cosmic-connect-protocol" ]]; then
    echo "Protocol changes detected. Remember to run /sync-repos!"
fi
```

### GitHub Actions (Optional)
Create a check that reminds you to sync:
```yaml
# .github/workflows/sync-reminder.yml
name: Sync Reminder
on: [pull_request]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check for protocol changes
        run: |
          if git diff origin/main --name-only | grep -q "cosmic-connect-protocol"; then
            echo "::warning::Protocol changes detected. Run /sync-repos before merging!"
          fi
```

## Customization

You can customize the skill by editing `.sync-config.yaml`:

```yaml
# Add new trigger
triggers:
  custom_type_change:
    files: ["cosmic-connect-protocol/src/custom/*.rs"]
    pattern: "pub struct.*Custom"
    sync_to: [core]
    severity: medium
```

## Best Practices

1. **Sync Early, Sync Often** - Don't let changes accumulate
2. **Review Each Change** - Don't blindly approve all syncs
3. **Test Both Repos** - Run tests in core and android after sync
4. **Document Breaking Changes** - Add to CHANGELOG.md in each repo
5. **Version Bumps** - Update version numbers appropriately

## Troubleshooting

**Q: Claude suggests syncing something I don't want to sync**
A: Just say "no" or "skip" when Claude asks for confirmation

**Q: Claude generated incorrect Kotlin code**
A: Ask Claude to revise: "The Kotlin code should use Flow instead of LiveData"

**Q: I want to undo a sync**
A: Ask Claude: "Roll back the last sync to cosmic-connect-android"

**Q: Claude missed a change**
A: Point it out: "You missed the new timeout constant, please sync that"

---

## Summary

This is an **AI-assisted, interactive sync workflow** where Claude:
- ‚úÖ Analyzes changes intelligently
- ‚úÖ Asks for your approval at each step
- ‚úÖ Generates language-appropriate code
- ‚úÖ Provides context and recommendations
- ‚úÖ Helps you maintain consistency
- ‚ùå Never auto-syncs without your approval
- ‚ùå Never makes assumptions about your intent

Think of it as **pair programming with Claude for multi-repo maintenance**.
